<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Gestion des Soldes</title>

  <style>
    * { box-sizing: border-box; font-family: "Segoe UI", Tahoma, sans-serif; }
    body { margin: 0; background: #f4f6f9; display: flex; }

    /* SIDEBAR */
    .sidebar {
      width: 260px; background: #fff; height: 100vh; padding: 25px 20px;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.08);
      position: fixed; left: 0; top: 0;
      transition: transform .3s ease;
    }
    .sidebar.hidden { transform: translateX(-270px); }
    .sidebar h2 { margin-bottom: 26px; color: #2e7d32; font-size: 22px; }
    .sidebar a {
      text-decoration: none; padding: 12px 15px; margin-bottom: 10px;
      background: #f5f5f5; border-radius: 8px; display: block;
      color: #333; font-weight: 600; transition: .25s;
    }
    .sidebar a:hover { background: #4CAF50; color: #fff; }

    /* MAIN */
    .main {
      margin-left: 280px; padding: 30px; width: calc(100% - 280px);
      transition: margin-left .3s ease;
    }
    .main.expanded { margin-left: 0; width: 100%; }

    header {
      display: flex; justify-content: space-between; align-items: center;
      background: #fff; padding: 18px 25px; border-radius: 14px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); margin-bottom: 18px;
    }
    .leftHead { display: flex; align-items: center; gap: 14px; }
    .menu-btn { font-size: 26px; cursor: pointer; user-select: none; }
    header img { height: 45px; }
    header h1 { margin: 0; font-size: 22px; color: #333; }

    /* FORM */
    .filters {
      background: #fff; border-radius: 16px; padding: 16px;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.08);
      display: flex; justify-content: space-between; gap: 12px; margin-bottom: 16px;
    }
    input, select {
      padding: 10px 12px; border-radius: 10px; border: 1px solid #ccc; font-size: 14px;
    }

    .section {
      background: #fff; border-radius: 18px; padding: 18px;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.08);
    }

    table { width: 100%; border-collapse: collapse; }
    th { background: #f5f5f5; padding: 12px; font-size: 13px; }
    td { padding: 12px; border-top: 1px solid #eee; font-size: 13px; }

    .empty { text-align: center; color: #777; padding: 20px; }

    .actions { display: flex; gap: 8px; }
    .btn {
      border: none; border-radius: 10px; padding: 10px 14px;
      font-weight: 700; cursor: pointer; transition: .2s;
    }
    .btn.primary { background: #4CAF50; color: #fff; }
    .btn.primary:hover { background: #43a047; }
    .btn.danger { background: #f44336; color: #fff; }
    .btn.danger:hover { background: #d32f2f; }

  </style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <h2>Admin Panel</h2>
  <a href="admin_home.html">Dashboard</a>
  <a href="admin_demandes.html">Demandes de congé</a>
  <a href="admin_calendar.html">Calendrier</a>
  <a href="admin_employees.html">Employés</a>
  <a href="admin_leave_types.html">Types de congés</a>
  <a href="admin_soldes.html">Soldes</a>
  <a href="admin_stats.html">Statistiques</a>
  <a href="admin_reports.html">Rapports / Export</a>
</div>

<!-- MAIN -->
<div class="main" id="main">

  <header>
    <div class="leftHead">
      <span class="menu-btn" id="menuToggle">☰</span>
      <h1>Gestion des Soldes</h1>
    </div>
  </header>

  <!-- FILTERS -->
  <div class="filters">
    <input id="searchCIN" placeholder="Rechercher par CIN">
    <button class="btn primary" onclick="updateSolde()">Mettre à jour le solde</button>
  </div>

  <!-- TABLE -->
  <div class="section">
    <table>
      <thead>
        <tr>
          <th>Nom</th>
          <th>CIN</th>
          <th>Département</th>
          <th>Solde</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="soldeTable">
        <tr><td colspan="5" class="empty">Chargement...</td></tr>
      </tbody>
    </table>
  </div>

</div>

<script>
  /* AUTH */
  const admin = JSON.parse(localStorage.getItem("adminUser"));
  if (!admin) window.location.href = "admin_login.html";

  /* SIDEBAR */
  document.getElementById("menuToggle").onclick = () => {
    sidebar.classList.toggle("hidden");
    main.classList.toggle("expanded");
  };

  let employees = JSON.parse(localStorage.getItem("employees")) || [];
  let soldeData = JSON.parse(localStorage.getItem("soldeData")) || [];

  /* RENDERING */
  function renderTable() {
    const tableBody = document.getElementById("soldeTable");
    if (employees.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="5" class="empty">Aucun employé trouvé</td></tr>`;
      return;
    }

    tableBody.innerHTML = employees.map((e, index) => {
      const solde = soldeData.find(s => s.cin === e.cin) || { solde: 0 };
      return `
        <tr>
          <td>${e.nom} ${e.prenom}</td>
          <td>${e.cin}</td>
          <td>${e.departement}</td>
          <td>${solde.solde} jours</td>
          <td class="actions">
            <button class="btn primary" onclick="updateSoldeForm(${index})">Modifier</button>
          </td>
        </tr>
      `;
    }).join("");
  }

  function updateSoldeForm(index) {
    const employee = employees[index];
    const currentSolde = soldeData.find(s => s.cin === employee.cin) || { solde: 0 };
    const newSolde = prompt(`Modifier le solde de ${employee.nom} (${employee.cin}) :`, currentSolde.solde);
    if (newSolde !== null) {
      if (!isNaN(newSolde)) {
        const updatedSolde = parseFloat(newSolde);
        const soldeIndex = soldeData.findIndex(s => s.cin === employee.cin);
        if (soldeIndex !== -1) {
          soldeData[soldeIndex].solde = updatedSolde;
        } else {
          soldeData.push({ cin: employee.cin, solde: updatedSolde });
        }
        localStorage.setItem("soldeData", JSON.stringify(soldeData));
        renderTable();
      } else {
        alert("Veuillez entrer une valeur numérique valide.");
      }
    }
  }

  function updateSolde() {
    const searchCIN = document.getElementById("searchCIN").value;
    const employee = employees.find(e => e.cin === searchCIN);
    if (employee) {
      const currentSolde = soldeData.find(s => s.cin === employee.cin) || { solde: 0 };
      const newSolde = prompt(`Modifier le solde de ${employee.nom} (${employee.cin}) :`, currentSolde.solde);
      if (newSolde !== null) {
        if (!isNaN(newSolde)) {
          const updatedSolde = parseFloat(newSolde);
          const soldeIndex = soldeData.findIndex(s => s.cin === employee.cin);
          if (soldeIndex !== -1) {
            soldeData[soldeIndex].solde = updatedSolde;
          } else {
            soldeData.push({ cin: employee.cin, solde: updatedSolde });
          }
          localStorage.setItem("soldeData", JSON.stringify(soldeData));
          renderTable();
        } else {
          alert("Veuillez entrer une valeur numérique valide.");
        }
      }
    } else {
      alert("Aucun employé trouvé avec ce CIN.");
    }
  }

  /* INIT */
  renderTable();
</script>

</body>
</html>
